#include <gtest/gtest.h>

#include "common.hpp"

#include <arbor/arbexcept.hpp>
#include <arbor/cable_cell.hpp>
#include <arbor/domain_decomposition.hpp>
#include <arbor/adex_cell.hpp>
#include <arbor/load_balance.hpp>
#include <arbor/recipe.hpp>
#include <arbor/schedule.hpp>
#include <arbor/simulation.hpp>
#include <arbor/spike_source_cell.hpp>
#include <arbor/units.hpp>

namespace U = arb::units;
using namespace U::literals;

namespace {
// Simple ring network of ADEX neurons.
// with one regularly spiking cell (fake cell) connected to the first cell in the ring.
struct ring_recipe: public arb::recipe {
    ring_recipe(arb::cell_size_type n_adex_cells, float weight, const U::quantity& delay):
        n_adex_cells_(n_adex_cells), weight_(weight), delay_(delay)
    {}

    arb::cell_size_type num_cells() const override { return n_adex_cells_ + 1; }

    // ADEX neurons have gid in range [1..n_adex_cells_] whereas fake cell is numbered with 0.
    arb::cell_kind get_cell_kind(arb::cell_gid_type gid) const override {
        if (gid == 0) return arb::cell_kind::spike_source;
        return arb::cell_kind::adex;
    }

    std::vector<arb::cell_connection> connections_on(arb::cell_gid_type gid) const override {
        if (gid == 0) return {};

        // In a ring, each cell has just one incoming connection.
        // gid-1 >= 0 since gid != 0
        auto src_gid = (gid - 1) % n_adex_cells_;
        std::vector<arb::cell_connection> connections;
        connections.emplace_back(arb::cell_global_label_type{src_gid, "src"}, arb::cell_local_label_type{"tgt"}, weight_, delay_);

        // If first ADEX cell, then connect from the last ADEX cell, too
        if (gid == 1) {
            auto src_gid = n_adex_cells_;
            connections.emplace_back(arb::cell_global_label_type{src_gid, "src"}, arb::cell_local_label_type{"tgt"}, weight_, delay_);
        }
        return connections;
    }

    arb::util::unique_any get_cell_description(arb::cell_gid_type gid) const override {
        // regularly spiking cell; produces a single spike at time 0.
        if (gid == 0) return arb::spike_source_cell("src",
                                                    arb::explicit_schedule({0.0_ms}));
        return arb::adex_cell{"src", "tgt"};
    }

private:
    arb::cell_size_type n_adex_cells_;
    float weight_;
    U::quantity delay_ = 42.0_ms;
};

// ADEX cells connected in the manner of a path 0->1->...->n-1.
struct path_recipe: public arb::recipe {
    path_recipe(arb::cell_size_type n, float weight, const U::quantity& delay):
        ncells_(n), weight_(weight), delay_(delay) {}

    arb::cell_size_type num_cells() const override { return ncells_; }
    arb::cell_kind get_cell_kind(arb::cell_gid_type gid) const override { return arb::cell_kind::adex; }
    arb::util::unique_any get_cell_description(arb::cell_gid_type gid) const override { return arb::adex_cell{.source="src", .target="tgt"}; }

    std::vector<arb::cell_connection> connections_on(arb::cell_gid_type gid) const override {
        if (gid == 0) return {};
        return {{{gid-1, "src"}, {"tgt"}, weight_, delay_}};
    }

    std::vector<arb::event_generator> event_generators(arb::cell_gid_type gid) const override {
        if (gid != 0) return {};
        return {
            arb::explicit_generator_from_milliseconds({"tgt"},
                                                      1000.0,           // use a large weight to trigger spikes
                                                      std::vector{ 1.0, // First event to trigger the spike
                                                                   1.1, // inside refractory period; should be ignored
                                                                   50.0 // long after previous event; should trigger new spike
                                                      })};
    }


private:
    arb::cell_size_type ncells_;
    float weight_;
    U::quantity delay_;
};

// ADEX cell with probe
struct adex_probe_recipe: public arb::recipe {
    adex_probe_recipe(std::size_t n_conn = 0): n_conn_{n_conn} {}

    arb::cell_size_type num_cells() const override { return 2; }
    arb::cell_kind get_cell_kind(arb::cell_gid_type gid) const override { return arb::cell_kind::adex; }
    std::vector<arb::cell_connection> connections_on(arb::cell_gid_type gid) const override {
        return {n_conn_,
                {arb::cell_global_label_type{0, "src"},
                 arb::cell_local_label_type{"tgt"},
                 0.0,
                 0.005_ms}};
    }
    arb::util::unique_any get_cell_description(arb::cell_gid_type gid) const override {
        auto cell = arb::adex_cell{.source="src", .target="tgt"};
        cell.V_th = 10_mV;
        if (0 == gid) {
            cell.E_R   = -23.0_mV;
            cell.V_m   = -18.0_mV;
            cell.E_L   = -13.0_mV;
            cell.t_ref =   0.8_ms;
            cell.tau   =   5.0_ms;
        }
        return cell;
    }
    std::vector<arb::probe_info> get_probes(arb::cell_gid_type gid) const override {
        return {{arb::adex_probe_voltage{}, "a"}};
    }
    std::vector<arb::event_generator> event_generators(arb::cell_gid_type) const override {
        return {
            arb::regular_generator({"tgt"},
                                   200.0,
                                   2.0_ms,
                                   1.0_ms,
                                   6.0_ms)
        };
    }

    std::size_t n_conn_ = 0;
};
} // namespace

TEST(adex_cell_group, throw) {
    adex_probe_recipe rec;
    auto context = arb::make_context();
    auto decomp = partition_load_balance(rec, context);
    EXPECT_NO_THROW(arb::simulation(rec, context, decomp));
}


TEST(adex_cell_group, recipe)
{
    ring_recipe rr(100, 1, 0.1_ms);
    EXPECT_EQ(101u, rr.num_cells());
    EXPECT_EQ(0u, rr.connections_on(0u).size());
    EXPECT_EQ(1u, rr.connections_on(55u).size());
    auto conns_gid_1 = rr.connections_on(1);
    EXPECT_EQ(2u,   conns_gid_1.size());
    EXPECT_EQ(0u,   conns_gid_1[0].source.gid);
    EXPECT_EQ(100u, conns_gid_1[1].source.gid);
}

TEST(adex_cell_group, spikes) {
    // make two adex cells
    path_recipe recipe(2, 1000, 0.1_ms);
    arb::simulation sim(recipe);
    sim.run(100_ms, 0.01_ms);
    // we expect 4 spikes: 2 by both neurons
    EXPECT_EQ(4u, sim.num_spikes());
}

TEST(adex_cell_group, ring)
{
    // Total number of ADEX cells.
    arb::cell_size_type num_adex_cells = 99;
    double weight = 1000;
    auto delay = 1.0_ms;
    auto recipe = ring_recipe(num_adex_cells, weight, delay);
    // Creates a simulation with a ring recipe of adex neurons
    arb::simulation sim(recipe);

    std::vector<arb::spike> spike_buffer;

    sim.set_global_spike_callback(
        [&spike_buffer](const std::vector<arb::spike>& spikes) {
            spike_buffer.insert(spike_buffer.end(), spikes.begin(), spikes.end());
        }
    );

    // Runs the simulation for simulation_time with given timestep
    sim.run(100_ms, 0.01_ms);
    // The total number of cells in all the cell groups.
    // There is one additional fake cell (regularly spiking cell).
    EXPECT_EQ(num_adex_cells + 1u, recipe.num_cells());

    for (auto& spike: spike_buffer) {
        // Assumes that delay = 1
        // We expect that Regular Spiking Cell spiked at time 0s.
        if (spike.source.gid == 0) {
            EXPECT_EQ(0, spike.time);
        // Other ADEX cell should spike consecutively.
        } else {
            EXPECT_EQ(spike.source.gid, spike.time);
        }
    }
}

struct Um_type {
    constexpr static double delta = 1e-6;
    double t;
    double u;

    friend std::ostream& operator<<(std::ostream& os, const Um_type& um) {
        os << "{ " << um.t << ", " << um.u << " }";
        return os;
    }

    friend bool operator==(const Um_type& lhs, const Um_type& rhs) {
        return (std::abs(lhs.t - rhs.t) <= delta)
            && (std::abs(lhs.u - rhs.u) <= delta);
    }
};

TEST(adex_cell_group, probe) {
    auto ums = std::unordered_map<arb::cell_address_type, std::vector<Um_type>>{};
    auto fun = [&ums](arb::probe_metadata pm,
                      std::size_t n,
                      const arb::sample_record* samples) {
        for (std::size_t ix = 0; ix < n; ++ix) {
            const auto& [t, v] = samples[ix];
            EXPECT_NE(arb::util::any_cast<const double*>(v), nullptr);
            double u = *arb::util::any_cast<const double*>(v);
            ums[pm.id].push_back({t, u});
        }
    };
    auto rec = adex_probe_recipe{};
    auto sim = arb::simulation(rec);

    sim.add_sampler(arb::all_probes, arb::regular_schedule(0.025_ms), fun);

    std::vector<arb::spike> spikes;

    sim.set_global_spike_callback([&spikes](const std::vector<arb::spike>& spk) {
        for (const auto& s: spk) spikes.push_back(s);
    });

    sim.run(10.0_ms, 0.0025_ms);
    std::vector<Um_type> exp = {{ 0.0000000, -18.0000000 },
                                { 0.0250000, -17.9870641 },
                                { 0.0500000, -17.9741517 },
                                { 0.0750000, -17.9612628 },
                                { 0.1000000, -17.9483975 },
                                { 0.1250000, -17.9355558 },
                                { 0.1500000, -17.9227377 },
                                { 0.1750000, -17.9099431 },
                                { 0.2000000, -17.8971722 },
                                { 0.2250000, -17.8844249 },
                                { 0.2500000, -17.8717013 },
                                { 0.2750000, -17.8590013 },
                                { 0.3000000, -17.8463250 },
                                { 0.3250000, -17.8336723 },
                                { 0.3500000, -17.8210433 },
                                { 0.3750000, -17.8084381 },
                                { 0.4000000, -17.7958565 },
                                { 0.4250000, -17.7832986 },
                                { 0.4500000, -17.7707645 },
                                { 0.4750000, -17.7582541 },
                                { 0.5000000, -17.7457674 },
                                { 0.5250000, -17.7333045 },
                                { 0.5500000, -17.7208653 },
                                { 0.5750000, -17.7084498 },
                                { 0.6000000, -17.6960582 },
                                { 0.6250000, -17.6836903 },
                                { 0.6500000, -17.6713462 },
                                { 0.6750000, -17.6590258 },
                                { 0.7000000, -17.6467293 },
                                { 0.7250000, -17.6344565 },
                                { 0.7500000, -17.6222075 },
                                { 0.7750000, -17.6099823 },
                                { 0.8000000, -17.5977810 },
                                { 0.8250000, -17.5856034 },
                                { 0.8500000, -17.5734496 },
                                { 0.8750000, -17.5613196 },
                                { 0.9000000, -17.5492134 },
                                { 0.9250000, -17.5371311 },
                                { 0.9500000, -17.5250725 },
                                { 0.9750000, -17.5130377 },
                                { 1.0000000, -17.5010268 },
                                { 1.0250000, -17.4890396 },
                                { 1.0500000, -17.4770763 },
                                { 1.0750000, -17.4651368 },
                                { 1.1000000, -17.4532210 },
                                { 1.1250000, -17.4413291 },
                                { 1.1500000, -17.4294610 },
                                { 1.1750000, -17.4176166 },
                                { 1.2000000, -17.4057961 },
                                { 1.2250000, -17.3939993 },
                                { 1.2500000, -17.3822264 },
                                { 1.2750000, -17.3704772 },
                                { 1.3000000, -17.3587518 },
                                { 1.3250000, -17.3470501 },
                                { 1.3500000, -17.3353723 },
                                { 1.3750000, -17.3237182 },
                                { 1.4000000, -17.3120878 },
                                { 1.4250000, -17.3004812 },
                                { 1.4500000, -17.2888984 },
                                { 1.4750000, -17.2773393 },
                                { 1.5000000, -17.2658039 },
                                { 1.5250000, -17.2542923 },
                                { 1.5500000, -17.2428043 },
                                { 1.5750000, -17.2313401 },
                                { 1.6000000, -17.2198996 },
                                { 1.6250000, -17.2084828 },
                                { 1.6500000, -17.1970897 },
                                { 1.6750000, -17.1857202 },
                                { 1.7000000, -17.1743744 },
                                { 1.7250000, -17.1630523 },
                                { 1.7500000, -17.1517538 },
                                { 1.7750000, -17.1404789 },
                                { 1.8000000, -17.1292277 },
                                { 1.8250000, -17.1180001 },
                                { 1.8500000, -17.1067961 },
                                { 1.8750000, -17.0956157 },
                                { 1.9000000, -17.0844589 },
                                { 1.9250000, -17.0733257 },
                                { 1.9500000, -17.0622160 },
                                { 1.9750000, -17.0511299 },
                                { 2.0000000, -17.0400673 },
                                { 2.0250000, -23.0000000 },
                                { 2.0500000, -23.0000000 },
                                { 2.0750000, -23.0000000 },
                                { 2.1000000, -23.0000000 },
                                { 2.1250000, -23.0000000 },
                                { 2.1500000, -23.0000000 },
                                { 2.1750000, -23.0000000 },
                                { 2.2000000, -23.0000000 },
                                { 2.2250000, -23.0000000 },
                                { 2.2500000, -23.0000000 },
                                { 2.2750000, -23.0000000 },
                                { 2.3000000, -23.0000000 },
                                { 2.3250000, -23.0000000 },
                                { 2.3500000, -23.0000000 },
                                { 2.3750000, -23.0000000 },
                                { 2.4000000, -23.0000000 },
                                { 2.4250000, -23.0000000 },
                                { 2.4500000, -23.0000000 },
                                { 2.4750000, -23.0000000 },
                                { 2.5000000, -23.0000000 },
                                { 2.5250000, -23.0000000 },
                                { 2.5500000, -23.0000000 },
                                { 2.5750000, -23.0000000 },
                                { 2.6000000, -23.0000000 },
                                { 2.6250000, -23.0000000 },
                                { 2.6500000, -23.0000000 },
                                { 2.6750000, -23.0000000 },
                                { 2.7000000, -23.0000000 },
                                { 2.7250000, -23.0000000 },
                                { 2.7500000, -23.0000000 },
                                { 2.7750000, -23.0000000 },
                                { 2.8000000, -23.0000000 },
                                { 2.8250000, -22.9801296 },
                                { 2.8500000, -22.9602603 },
                                { 2.8750000, -22.9403923 },
                                { 2.9000000, -22.9205260 },
                                { 2.9250000, -22.9006615 },
                                { 2.9500000, -22.8807993 },
                                { 2.9750000, -22.8609396 },
                                { 3.0000000, -22.8410827 },
                                { 3.0250000, -23.0000000 },
                                { 3.0500000, -23.0000000 },
                                { 3.0750000, -23.0000000 },
                                { 3.1000000, -23.0000000 },
                                { 3.1250000, -23.0000000 },
                                { 3.1500000, -23.0000000 },
                                { 3.1750000, -23.0000000 },
                                { 3.2000000, -23.0000000 },
                                { 3.2250000, -23.0000000 },
                                { 3.2500000, -23.0000000 },
                                { 3.2750000, -23.0000000 },
                                { 3.3000000, -23.0000000 },
                                { 3.3250000, -23.0000000 },
                                { 3.3500000, -23.0000000 },
                                { 3.3750000, -23.0000000 },
                                { 3.4000000, -23.0000000 },
                                { 3.4250000, -23.0000000 },
                                { 3.4500000, -23.0000000 },
                                { 3.4750000, -23.0000000 },
                                { 3.5000000, -23.0000000 },
                                { 3.5250000, -23.0000000 },
                                { 3.5500000, -23.0000000 },
                                { 3.5750000, -23.0000000 },
                                { 3.6000000, -23.0000000 },
                                { 3.6250000, -23.0000000 },
                                { 3.6500000, -23.0000000 },
                                { 3.6750000, -23.0000000 },
                                { 3.7000000, -23.0000000 },
                                { 3.7250000, -23.0000000 },
                                { 3.7500000, -23.0000000 },
                                { 3.7750000, -23.0000000 },
                                { 3.8000000, -23.0000000 },
                                { 3.8250000, -22.9868391 },
                                { 3.8500000, -22.9736278 },
                                { 3.8750000, -22.9603667 },
                                { 3.9000000, -22.9470564 },
                                { 3.9250000, -22.9336974 },
                                { 3.9500000, -22.9202904 },
                                { 3.9750000, -22.9068360 },
                                { 4.0000000, -22.8933346 },
                                { 4.0250000, -23.0000000 },
                                { 4.0500000, -23.0000000 },
                                { 4.0750000, -23.0000000 },
                                { 4.1000000, -23.0000000 },
                                { 4.1250000, -23.0000000 },
                                { 4.1500000, -23.0000000 },
                                { 4.1750000, -23.0000000 },
                                { 4.2000000, -23.0000000 },
                                { 4.2250000, -23.0000000 },
                                { 4.2500000, -23.0000000 },
                                { 4.2750000, -23.0000000 },
                                { 4.3000000, -23.0000000 },
                                { 4.3250000, -23.0000000 },
                                { 4.3500000, -23.0000000 },
                                { 4.3750000, -23.0000000 },
                                { 4.4000000, -23.0000000 },
                                { 4.4250000, -23.0000000 },
                                { 4.4500000, -23.0000000 },
                                { 4.4750000, -23.0000000 },
                                { 4.5000000, -23.0000000 },
                                { 4.5250000, -23.0000000 },
                                { 4.5500000, -23.0000000 },
                                { 4.5750000, -23.0000000 },
                                { 4.6000000, -23.0000000 },
                                { 4.6250000, -23.0000000 },
                                { 4.6500000, -23.0000000 },
                                { 4.6750000, -23.0000000 },
                                { 4.7000000, -23.0000000 },
                                { 4.7250000, -23.0000000 },
                                { 4.7500000, -23.0000000 },
                                { 4.7750000, -23.0000000 },
                                { 4.8000000, -23.0000000 },
                                { 4.8250000, -22.9932850 },
                                { 4.8500000, -22.9864702 },
                                { 4.8750000, -22.9795565 },
                                { 4.9000000, -22.9725448 },
                                { 4.9250000, -22.9654358 },
                                { 4.9500000, -22.9582305 },
                                { 4.9750000, -22.9509297 },
                                { 5.0000000, -23.0000000 },
                                { 5.0250000, -23.0000000 },
                                { 5.0500000, -23.0000000 },
                                { 5.0750000, -23.0000000 },
                                { 5.1000000, -23.0000000 },
                                { 5.1250000, -23.0000000 },
                                { 5.1500000, -23.0000000 },
                                { 5.1750000, -23.0000000 },
                                { 5.2000000, -23.0000000 },
                                { 5.2250000, -23.0000000 },
                                { 5.2500000, -23.0000000 },
                                { 5.2750000, -23.0000000 },
                                { 5.3000000, -23.0000000 },
                                { 5.3250000, -23.0000000 },
                                { 5.3500000, -23.0000000 },
                                { 5.3750000, -23.0000000 },
                                { 5.4000000, -23.0000000 },
                                { 5.4250000, -23.0000000 },
                                { 5.4500000, -23.0000000 },
                                { 5.4750000, -23.0000000 },
                                { 5.5000000, -23.0000000 },
                                { 5.5250000, -23.0000000 },
                                { 5.5500000, -23.0000000 },
                                { 5.5750000, -23.0000000 },
                                { 5.6000000, -23.0000000 },
                                { 5.6250000, -23.0000000 },
                                { 5.6500000, -23.0000000 },
                                { 5.6750000, -23.0000000 },
                                { 5.7000000, -23.0000000 },
                                { 5.7250000, -23.0000000 },
                                { 5.7500000, -23.0000000 },
                                { 5.7750000, -23.0000000 },
                                { 5.8000000, -23.0000000 },
                                { 5.8250000, -22.9994778 },
                                { 5.8500000, -22.9988083 },
                                { 5.8750000, -22.9979927 },
                                { 5.9000000, -22.9970322 },
                                { 5.9250000, -22.9959277 },
                                { 5.9500000, -22.9946805 },
                                { 5.9750000, -22.9932917 },
                                { 6.0000000, -22.9917623 },
                                { 6.0250000, -22.9900935 },
                                { 6.0500000, -22.9882863 },
                                { 6.0750000, -22.9863419 },
                                { 6.1000000, -22.9842613 },
                                { 6.1250000, -22.9820456 },
                                { 6.1500000, -22.9796959 },
                                { 6.1750000, -22.9772132 },
                                { 6.2000000, -22.9745985 },
                                { 6.2250000, -22.9718530 },
                                { 6.2500000, -22.9689777 },
                                { 6.2750000, -22.9659735 },
                                { 6.3000000, -22.9628416 },
                                { 6.3250000, -22.9595830 },
                                { 6.3500000, -22.9561986 },
                                { 6.3750000, -22.9526895 },
                                { 6.4000000, -22.9490568 },
                                { 6.4250000, -22.9453013 },
                                { 6.4500000, -22.9414241 },
                                { 6.4750000, -22.9374262 },
                                { 6.5000000, -22.9333086 },
                                { 6.5250000, -22.9290722 },
                                { 6.5500000, -22.9247181 },
                                { 6.5750000, -22.9202471 },
                                { 6.6000000, -22.9156603 },
                                { 6.6250000, -22.9109586 },
                                { 6.6500000, -22.9061429 },
                                { 6.6750000, -22.9012143 },
                                { 6.7000000, -22.8961736 },
                                { 6.7250000, -22.8910217 },
                                { 6.7500000, -22.8857597 },
                                { 6.7750000, -22.8803884 },
                                { 6.8000000, -22.8749087 },
                                { 6.8250000, -22.8693216 },
                                { 6.8500000, -22.8636279 },
                                { 6.8750000, -22.8578286 },
                                { 6.9000000, -22.8519246 },
                                { 6.9250000, -22.8459167 },
                                { 6.9500000, -22.8398058 },
                                { 6.9750000, -22.8335929 },
                                { 7.0000000, -22.8272787 },
                                { 7.0250000, -22.8208642 },
                                { 7.0500000, -22.8143502 },
                                { 7.0750000, -22.8077376 },
                                { 7.1000000, -22.8010272 },
                                { 7.1250000, -22.7942199 },
                                { 7.1500000, -22.7873166 },
                                { 7.1750000, -22.7803180 },
                                { 7.2000000, -22.7732250 },
                                { 7.2250000, -22.7660385 },
                                { 7.2500000, -22.7587592 },
                                { 7.2750000, -22.7513880 },
                                { 7.3000000, -22.7439256 },
                                { 7.3250000, -22.7363730 },
                                { 7.3500000, -22.7287309 },
                                { 7.3750000, -22.7210001 },
                                { 7.4000000, -22.7131814 },
                                { 7.4250000, -22.7052756 },
                                { 7.4500000, -22.6972835 },
                                { 7.4750000, -22.6892058 },
                                { 7.5000000, -22.6810434 },
                                { 7.5250000, -22.6727970 },
                                { 7.5500000, -22.6644673 },
                                { 7.5750000, -22.6560552 },
                                { 7.6000000, -22.6475614 },
                                { 7.6250000, -22.6389867 },
                                { 7.6500000, -22.6303317 },
                                { 7.6750000, -22.6215973 },
                                { 7.7000000, -22.6127842 },
                                { 7.7250000, -22.6038931 },
                                { 7.7500000, -22.5949247 },
                                { 7.7750000, -22.5858799 },
                                { 7.8000000, -22.5767592 },
                                { 7.8250000, -22.5675634 },
                                { 7.8500000, -22.5582933 },
                                { 7.8750000, -22.5489495 },
                                { 7.9000000, -22.5395328 },
                                { 7.9250000, -22.5300438 },
                                { 7.9500000, -22.5204832 },
                                { 7.9750000, -22.5108518 },
                                { 8.0000000, -22.5011502 },
                                { 8.0250000, -22.4913792 },
                                { 8.0500000, -22.4815393 },
                                { 8.0750000, -22.4716312 },
                                { 8.1000000, -22.4616557 },
                                { 8.1250000, -22.4516134 },
                                { 8.1500000, -22.4415050 },
                                { 8.1750000, -22.4313311 },
                                { 8.2000000, -22.4210923 },
                                { 8.2250000, -22.4107894 },
                                { 8.2500000, -22.4004229 },
                                { 8.2750000, -22.3899936 },
                                { 8.3000000, -22.3795020 },
                                { 8.3250000, -22.3689489 },
                                { 8.3500000, -22.3583347 },
                                { 8.3750000, -22.3476602 },
                                { 8.4000000, -22.3369259 },
                                { 8.4250000, -22.3261326 },
                                { 8.4500000, -22.3152807 },
                                { 8.4750000, -22.3043710 },
                                { 8.5000000, -22.2934040 },
                                { 8.5250000, -22.2823803 },
                                { 8.5500000, -22.2713006 },
                                { 8.5750000, -22.2601654 },
                                { 8.6000000, -22.2489753 },
                                { 8.6250000, -22.2377309 },
                                { 8.6500000, -22.2264328 },
                                { 8.6750000, -22.2150816 },
                                { 8.7000000, -22.2036778 },
                                { 8.7250000, -22.1922221 },
                                { 8.7500000, -22.1807149 },
                                { 8.7750000, -22.1691570 },
                                { 8.8000000, -22.1575487 },
                                { 8.8250000, -22.1458908 },
                                { 8.8500000, -22.1341837 },
                                { 8.8750000, -22.1224280 },
                                { 8.9000000, -22.1106242 },
                                { 8.9250000, -22.0987729 },
                                { 8.9500000, -22.0868747 },
                                { 8.9750000, -22.0749301 },
                                { 9.0000000, -22.0629396 },
                                { 9.0250000, -22.0509037 },
                                { 9.0500000, -22.0388230 },
                                { 9.0750000, -22.0266980 },
                                { 9.1000000, -22.0145292 },
                                { 9.1250000, -22.0023172 },
                                { 9.1500000, -21.9900624 },
                                { 9.1750000, -21.9777654 },
                                { 9.2000000, -21.9654266 },
                                { 9.2250000, -21.9530467 },
                                { 9.2500000, -21.9406260 },
                                { 9.2750000, -21.9281652 },
                                { 9.3000000, -21.9156646 },
                                { 9.3250000, -21.9031248 },
                                { 9.3500000, -21.8905462 },
                                { 9.3750000, -21.8779294 },
                                { 9.4000000, -21.8652749 },
                                { 9.4250000, -21.8525831 },
                                { 9.4500000, -21.8398544 },
                                { 9.4750000, -21.8270894 },
                                { 9.5000000, -21.8142886 },
                                { 9.5250000, -21.8014524 },
                                { 9.5500000, -21.7885812 },
                                { 9.5750000, -21.7756756 },
                                { 9.6000000, -21.7627359 },
                                { 9.6250000, -21.7497628 },
                                { 9.6500000, -21.7367565 },
                                { 9.6750000, -21.7237176 },
                                { 9.7000000, -21.7106464 },
                                { 9.7250000, -21.6975435 },
                                { 9.7500000, -21.6844093 },
                                { 9.7750000, -21.6712442 },
                                { 9.8000000, -21.6580487 },
                                { 9.8250000, -21.6448232 },
                                { 9.8500000, -21.6315680 },
                                { 9.8750000, -21.6182838 },
                                { 9.9000000, -21.6049708 },
                                { 9.9250000, -21.5916295 },
                                { 9.9500000, -21.5782603 },
                                { 9.9750000, -21.5648636 },};
    
    ASSERT_TRUE(testing::seq_eq(ums[{0, "a"}], exp));
    // gid == 1 is different, but of same size
    EXPECT_EQ((ums[{1, "a"}].size()), exp.size());
    ASSERT_FALSE(testing::seq_eq(ums[{1, "a"}], exp));
    // now check the spikes
    std::sort(spikes.begin(), spikes.end());
    EXPECT_EQ(spikes.size(), 0u);
    std::vector<arb::spike> sexp{};
    ASSERT_EQ(spikes, sexp);
}

TEST(adex_cell_group, probe_with_connections) {
    auto ums = std::unordered_map<arb::cell_address_type, std::vector<Um_type>>{};
    auto fun = [&ums](arb::probe_metadata pm,
                      std::size_t n,
                      const arb::sample_record* samples) {
        for (std::size_t ix = 0; ix < n; ++ix) {
            const auto& [t, v] = samples[ix];
            double u = *arb::util::any_cast<const double*>(v);
            ums[pm.id].push_back({t, u});
        }
    };
    auto rec = adex_probe_recipe{5};
    auto sim = arb::simulation(rec);

    sim.add_sampler(arb::all_probes, arb::regular_schedule(0.025_ms), fun);

    std::vector<arb::spike> spikes;

    sim.set_global_spike_callback(
        [&spikes](const std::vector<arb::spike>& spk) { for (const auto& s: spk) spikes.push_back(s); }
    );

    sim.run(10.0_ms, 0.0025_ms);

    std::vector<Um_type> exp = {{ 0.0000000, -18.0000000 },
                                { 0.0250000, -17.9870641 },
                                { 0.0500000, -17.9741517 },
                                { 0.0750000, -17.9612628 },
                                { 0.1000000, -17.9483975 },
                                { 0.1250000, -17.9355558 },
                                { 0.1500000, -17.9227377 },
                                { 0.1750000, -17.9099431 },
                                { 0.2000000, -17.8971722 },
                                { 0.2250000, -17.8844249 },
                                { 0.2500000, -17.8717013 },
                                { 0.2750000, -17.8590013 },
                                { 0.3000000, -17.8463250 },
                                { 0.3250000, -17.8336723 },
                                { 0.3500000, -17.8210433 },
                                { 0.3750000, -17.8084381 },
                                { 0.4000000, -17.7958565 },
                                { 0.4250000, -17.7832986 },
                                { 0.4500000, -17.7707645 },
                                { 0.4750000, -17.7582541 },
                                { 0.5000000, -17.7457674 },
                                { 0.5250000, -17.7333045 },
                                { 0.5500000, -17.7208653 },
                                { 0.5750000, -17.7084498 },
                                { 0.6000000, -17.6960582 },
                                { 0.6250000, -17.6836903 },
                                { 0.6500000, -17.6713462 },
                                { 0.6750000, -17.6590258 },
                                { 0.7000000, -17.6467293 },
                                { 0.7250000, -17.6344565 },
                                { 0.7500000, -17.6222075 },
                                { 0.7750000, -17.6099823 },
                                { 0.8000000, -17.5977810 },
                                { 0.8250000, -17.5856034 },
                                { 0.8500000, -17.5734496 },
                                { 0.8750000, -17.5613196 },
                                { 0.9000000, -17.5492134 },
                                { 0.9250000, -17.5371311 },
                                { 0.9500000, -17.5250725 },
                                { 0.9750000, -17.5130377 },
                                { 1.0000000, -17.5010268 },
                                { 1.0250000, -17.4890396 },
                                { 1.0500000, -17.4770763 },
                                { 1.0750000, -17.4651368 },
                                { 1.1000000, -17.4532210 },
                                { 1.1250000, -17.4413291 },
                                { 1.1500000, -17.4294610 },
                                { 1.1750000, -17.4176166 },
                                { 1.2000000, -17.4057961 },
                                { 1.2250000, -17.3939993 },
                                { 1.2500000, -17.3822264 },
                                { 1.2750000, -17.3704772 },
                                { 1.3000000, -17.3587518 },
                                { 1.3250000, -17.3470501 },
                                { 1.3500000, -17.3353723 },
                                { 1.3750000, -17.3237182 },
                                { 1.4000000, -17.3120878 },
                                { 1.4250000, -17.3004812 },
                                { 1.4500000, -17.2888984 },
                                { 1.4750000, -17.2773393 },
                                { 1.5000000, -17.2658039 },
                                { 1.5250000, -17.2542923 },
                                { 1.5500000, -17.2428043 },
                                { 1.5750000, -17.2313401 },
                                { 1.6000000, -17.2198996 },
                                { 1.6250000, -17.2084828 },
                                { 1.6500000, -17.1970897 },
                                { 1.6750000, -17.1857202 },
                                { 1.7000000, -17.1743744 },
                                { 1.7250000, -17.1630523 },
                                { 1.7500000, -17.1517538 },
                                { 1.7750000, -17.1404789 },
                                { 1.8000000, -17.1292277 },
                                { 1.8250000, -17.1180001 },
                                { 1.8500000, -17.1067961 },
                                { 1.8750000, -17.0956157 },
                                { 1.9000000, -17.0844589 },
                                { 1.9250000, -17.0733257 },
                                { 1.9500000, -17.0622160 },
                                { 1.9750000, -17.0511299 },
                                { 2.0000000, -17.0401739 },
                                { 2.0250000, -23.0000000 },
                                { 2.0500000, -23.0000000 },
                                { 2.0750000, -23.0000000 },
                                { 2.1000000, -23.0000000 },
                                { 2.1250000, -23.0000000 },
                                { 2.1500000, -23.0000000 },
                                { 2.1750000, -23.0000000 },
                                { 2.2000000, -23.0000000 },
                                { 2.2250000, -23.0000000 },
                                { 2.2500000, -23.0000000 },
                                { 2.2750000, -23.0000000 },
                                { 2.3000000, -23.0000000 },
                                { 2.3250000, -23.0000000 },
                                { 2.3500000, -23.0000000 },
                                { 2.3750000, -23.0000000 },
                                { 2.4000000, -23.0000000 },
                                { 2.4250000, -23.0000000 },
                                { 2.4500000, -23.0000000 },
                                { 2.4750000, -23.0000000 },
                                { 2.5000000, -23.0000000 },
                                { 2.5250000, -23.0000000 },
                                { 2.5500000, -23.0000000 },
                                { 2.5750000, -23.0000000 },
                                { 2.6000000, -23.0000000 },
                                { 2.6250000, -23.0000000 },
                                { 2.6500000, -23.0000000 },
                                { 2.6750000, -23.0000000 },
                                { 2.7000000, -23.0000000 },
                                { 2.7250000, -23.0000000 },
                                { 2.7500000, -23.0000000 },
                                { 2.7750000, -23.0000000 },
                                { 2.8000000, -23.0000000 },
                                { 2.8250000, -22.9801296 },
                                { 2.8500000, -22.9602603 },
                                { 2.8750000, -22.9403923 },
                                { 2.9000000, -22.9205260 },
                                { 2.9250000, -22.9006615 },
                                { 2.9500000, -22.8807993 },
                                { 2.9750000, -22.8609396 },
                                { 3.0000000, -22.8410870 },
                                { 3.0250000, -23.0000000 },
                                { 3.0500000, -23.0000000 },
                                { 3.0750000, -23.0000000 },
                                { 3.1000000, -23.0000000 },
                                { 3.1250000, -23.0000000 },
                                { 3.1500000, -23.0000000 },
                                { 3.1750000, -23.0000000 },
                                { 3.2000000, -23.0000000 },
                                { 3.2250000, -23.0000000 },
                                { 3.2500000, -23.0000000 },
                                { 3.2750000, -23.0000000 },
                                { 3.3000000, -23.0000000 },
                                { 3.3250000, -23.0000000 },
                                { 3.3500000, -23.0000000 },
                                { 3.3750000, -23.0000000 },
                                { 3.4000000, -23.0000000 },
                                { 3.4250000, -23.0000000 },
                                { 3.4500000, -23.0000000 },
                                { 3.4750000, -23.0000000 },
                                { 3.5000000, -23.0000000 },
                                { 3.5250000, -23.0000000 },
                                { 3.5500000, -23.0000000 },
                                { 3.5750000, -23.0000000 },
                                { 3.6000000, -23.0000000 },
                                { 3.6250000, -23.0000000 },
                                { 3.6500000, -23.0000000 },
                                { 3.6750000, -23.0000000 },
                                { 3.7000000, -23.0000000 },
                                { 3.7250000, -23.0000000 },
                                { 3.7500000, -23.0000000 },
                                { 3.7750000, -23.0000000 },
                                { 3.8000000, -23.0000000 },
                                { 3.8250000, -22.9868391 },
                                { 3.8500000, -22.9736278 },
                                { 3.8750000, -22.9603667 },
                                { 3.9000000, -22.9470564 },
                                { 3.9250000, -22.9336974 },
                                { 3.9500000, -22.9202904 },
                                { 3.9750000, -22.9068360 },
                                { 4.0000000, -22.8933384 },
                                { 4.0250000, -23.0000000 },
                                { 4.0500000, -23.0000000 },
                                { 4.0750000, -23.0000000 },
                                { 4.1000000, -23.0000000 },
                                { 4.1250000, -23.0000000 },
                                { 4.1500000, -23.0000000 },
                                { 4.1750000, -23.0000000 },
                                { 4.2000000, -23.0000000 },
                                { 4.2250000, -23.0000000 },
                                { 4.2500000, -23.0000000 },
                                { 4.2750000, -23.0000000 },
                                { 4.3000000, -23.0000000 },
                                { 4.3250000, -23.0000000 },
                                { 4.3500000, -23.0000000 },
                                { 4.3750000, -23.0000000 },
                                { 4.4000000, -23.0000000 },
                                { 4.4250000, -23.0000000 },
                                { 4.4500000, -23.0000000 },
                                { 4.4750000, -23.0000000 },
                                { 4.5000000, -23.0000000 },
                                { 4.5250000, -23.0000000 },
                                { 4.5500000, -23.0000000 },
                                { 4.5750000, -23.0000000 },
                                { 4.6000000, -23.0000000 },
                                { 4.6250000, -23.0000000 },
                                { 4.6500000, -23.0000000 },
                                { 4.6750000, -23.0000000 },
                                { 4.7000000, -23.0000000 },
                                { 4.7250000, -23.0000000 },
                                { 4.7500000, -23.0000000 },
                                { 4.7750000, -23.0000000 },
                                { 4.8000000, -23.0000000 },
                                { 4.8250000, -22.9932850 },
                                { 4.8500000, -22.9864702 },
                                { 4.8750000, -22.9795565 },
                                { 4.9000000, -22.9725448 },
                                { 4.9250000, -22.9654358 },
                                { 4.9500000, -22.9582305 },
                                { 4.9750000, -22.9509297 },
                                { 5.0000000, -22.9435368 },
                                { 5.0250000, -23.0000000 },
                                { 5.0500000, -23.0000000 },
                                { 5.0750000, -23.0000000 },
                                { 5.1000000, -23.0000000 },
                                { 5.1250000, -23.0000000 },
                                { 5.1500000, -23.0000000 },
                                { 5.1750000, -23.0000000 },
                                { 5.2000000, -23.0000000 },
                                { 5.2250000, -23.0000000 },
                                { 5.2500000, -23.0000000 },
                                { 5.2750000, -23.0000000 },
                                { 5.3000000, -23.0000000 },
                                { 5.3250000, -23.0000000 },
                                { 5.3500000, -23.0000000 },
                                { 5.3750000, -23.0000000 },
                                { 5.4000000, -23.0000000 },
                                { 5.4250000, -23.0000000 },
                                { 5.4500000, -23.0000000 },
                                { 5.4750000, -23.0000000 },
                                { 5.5000000, -23.0000000 },
                                { 5.5250000, -23.0000000 },
                                { 5.5500000, -23.0000000 },
                                { 5.5750000, -23.0000000 },
                                { 5.6000000, -23.0000000 },
                                { 5.6250000, -23.0000000 },
                                { 5.6500000, -23.0000000 },
                                { 5.6750000, -23.0000000 },
                                { 5.7000000, -23.0000000 },
                                { 5.7250000, -23.0000000 },
                                { 5.7500000, -23.0000000 },
                                { 5.7750000, -23.0000000 },
                                { 5.8000000, -23.0000000 },
                                { 5.8250000, -22.9994778 },
                                { 5.8500000, -22.9988083 },
                                { 5.8750000, -22.9979927 },
                                { 5.9000000, -22.9970322 },
                                { 5.9250000, -22.9959277 },
                                { 5.9500000, -22.9946805 },
                                { 5.9750000, -22.9932917 },
                                { 6.0000000, -22.9917623 },
                                { 6.0250000, -22.9900935 },
                                { 6.0500000, -22.9882863 },
                                { 6.0750000, -22.9863419 },
                                { 6.1000000, -22.9842613 },
                                { 6.1250000, -22.9820456 },
                                { 6.1500000, -22.9796959 },
                                { 6.1750000, -22.9772132 },
                                { 6.2000000, -22.9745985 },
                                { 6.2250000, -22.9718530 },
                                { 6.2500000, -22.9689777 },
                                { 6.2750000, -22.9659735 },
                                { 6.3000000, -22.9628416 },
                                { 6.3250000, -22.9595830 },
                                { 6.3500000, -22.9561986 },
                                { 6.3750000, -22.9526895 },
                                { 6.4000000, -22.9490568 },
                                { 6.4250000, -22.9453013 },
                                { 6.4500000, -22.9414241 },
                                { 6.4750000, -22.9374262 },
                                { 6.5000000, -22.9333086 },
                                { 6.5250000, -22.9290722 },
                                { 6.5500000, -22.9247181 },
                                { 6.5750000, -22.9202471 },
                                { 6.6000000, -22.9156603 },
                                { 6.6250000, -22.9109586 },
                                { 6.6500000, -22.9061429 },
                                { 6.6750000, -22.9012143 },
                                { 6.7000000, -22.8961736 },
                                { 6.7250000, -22.8910217 },
                                { 6.7500000, -22.8857597 },
                                { 6.7750000, -22.8803884 },
                                { 6.8000000, -22.8749087 },
                                { 6.8250000, -22.8693216 },
                                { 6.8500000, -22.8636279 },
                                { 6.8750000, -22.8578286 },
                                { 6.9000000, -22.8519246 },
                                { 6.9250000, -22.8459167 },
                                { 6.9500000, -22.8398058 },
                                { 6.9750000, -22.8335929 },
                                { 7.0000000, -22.8272787 },
                                { 7.0250000, -22.8208642 },
                                { 7.0500000, -22.8143502 },
                                { 7.0750000, -22.8077376 },
                                { 7.1000000, -22.8010272 },
                                { 7.1250000, -22.7942199 },
                                { 7.1500000, -22.7873166 },
                                { 7.1750000, -22.7803180 },
                                { 7.2000000, -22.7732250 },
                                { 7.2250000, -22.7660385 },
                                { 7.2500000, -22.7587592 },
                                { 7.2750000, -22.7513880 },
                                { 7.3000000, -22.7439256 },
                                { 7.3250000, -22.7363730 },
                                { 7.3500000, -22.7287309 },
                                { 7.3750000, -22.7210001 },
                                { 7.4000000, -22.7131814 },
                                { 7.4250000, -22.7052756 },
                                { 7.4500000, -22.6972835 },
                                { 7.4750000, -22.6892058 },
                                { 7.5000000, -22.6810434 },
                                { 7.5250000, -22.6727970 },
                                { 7.5500000, -22.6644673 },
                                { 7.5750000, -22.6560552 },
                                { 7.6000000, -22.6475614 },
                                { 7.6250000, -22.6389867 },
                                { 7.6500000, -22.6303317 },
                                { 7.6750000, -22.6215973 },
                                { 7.7000000, -22.6127842 },
                                { 7.7250000, -22.6038931 },
                                { 7.7500000, -22.5949247 },
                                { 7.7750000, -22.5858799 },
                                { 7.8000000, -22.5767592 },
                                { 7.8250000, -22.5675634 },
                                { 7.8500000, -22.5582933 },
                                { 7.8750000, -22.5489495 },
                                { 7.9000000, -22.5395328 },
                                { 7.9250000, -22.5300438 },
                                { 7.9500000, -22.5204832 },
                                { 7.9750000, -22.5108518 },
                                { 8.0000000, -22.5011502 },
                                { 8.0250000, -22.4913792 },
                                { 8.0500000, -22.4815393 },
                                { 8.0750000, -22.4716312 },
                                { 8.1000000, -22.4616557 },
                                { 8.1250000, -22.4516134 },
                                { 8.1500000, -22.4415050 },
                                { 8.1750000, -22.4313311 },
                                { 8.2000000, -22.4210923 },
                                { 8.2250000, -22.4107894 },
                                { 8.2500000, -22.4004229 },
                                { 8.2750000, -22.3899936 },
                                { 8.3000000, -22.3795020 },
                                { 8.3250000, -22.3689489 },
                                { 8.3500000, -22.3583347 },
                                { 8.3750000, -22.3476602 },
                                { 8.4000000, -22.3369259 },
                                { 8.4250000, -22.3261326 },
                                { 8.4500000, -22.3152807 },
                                { 8.4750000, -22.3043710 },
                                { 8.5000000, -22.2934040 },
                                { 8.5250000, -22.2823803 },
                                { 8.5500000, -22.2713006 },
                                { 8.5750000, -22.2601654 },
                                { 8.6000000, -22.2489753 },
                                { 8.6250000, -22.2377309 },
                                { 8.6500000, -22.2264328 },
                                { 8.6750000, -22.2150816 },
                                { 8.7000000, -22.2036778 },
                                { 8.7250000, -22.1922221 },
                                { 8.7500000, -22.1807149 },
                                { 8.7750000, -22.1691570 },
                                { 8.8000000, -22.1575487 },
                                { 8.8250000, -22.1458908 },
                                { 8.8500000, -22.1341837 },
                                { 8.8750000, -22.1224280 },
                                { 8.9000000, -22.1106242 },
                                { 8.9250000, -22.0987729 },
                                { 8.9500000, -22.0868747 },
                                { 8.9750000, -22.0749301 },
                                { 9.0000000, -22.0629396 },
                                { 9.0250000, -22.0509037 },
                                { 9.0500000, -22.0388230 },
                                { 9.0750000, -22.0266980 },
                                { 9.1000000, -22.0145292 },
                                { 9.1250000, -22.0023172 },
                                { 9.1500000, -21.9900624 },
                                { 9.1750000, -21.9777654 },
                                { 9.2000000, -21.9654266 },
                                { 9.2250000, -21.9530467 },
                                { 9.2500000, -21.9406260 },
                                { 9.2750000, -21.9281652 },
                                { 9.3000000, -21.9156646 },
                                { 9.3250000, -21.9031248 },
                                { 9.3500000, -21.8905462 },
                                { 9.3750000, -21.8779294 },
                                { 9.4000000, -21.8652749 },
                                { 9.4250000, -21.8525831 },
                                { 9.4500000, -21.8398544 },
                                { 9.4750000, -21.8270894 },
                                { 9.5000000, -21.8142886 },
                                { 9.5250000, -21.8014524 },
                                { 9.5500000, -21.7885812 },
                                { 9.5750000, -21.7756756 },
                                { 9.6000000, -21.7627359 },
                                { 9.6250000, -21.7497628 },
                                { 9.6500000, -21.7367565 },
                                { 9.6750000, -21.7237176 },
                                { 9.7000000, -21.7106464 },
                                { 9.7250000, -21.6975435 },
                                { 9.7500000, -21.6844093 },
                                { 9.7750000, -21.6712442 },
                                { 9.8000000, -21.6580487 },
                                { 9.8250000, -21.6448232 },
                                { 9.8500000, -21.6315680 },
                                { 9.8750000, -21.6182838 },
                                { 9.9000000, -21.6049708 },
                                { 9.9250000, -21.5916295 },
                                { 9.9500000, -21.5782603 },
                                { 9.9750000, -21.5648636 },};
    
    EXPECT_EQ((ums[{0, "a"}].size()), exp.size());
    ASSERT_TRUE(testing::seq_eq(ums[{0, "a"}], exp));
    // gid == 1 is different, but of same size
    EXPECT_EQ((ums[{1, "a"}].size()), exp.size());
    ASSERT_FALSE(testing::seq_eq(ums[{1, "a"}], exp));
    // now check the spikes
    std::sort(spikes.begin(), spikes.end());
    EXPECT_EQ(spikes.size(), 4u);
    std::vector<arb::spike> sexp{{{0, 0}, 2}, {{0, 0}, 3}, {{0, 0}, 4}, {{0, 0}, 5},};
    ASSERT_EQ(spikes, sexp);
}
